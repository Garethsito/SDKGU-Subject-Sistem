<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SDGKU</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/337be747ec.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<!-- 
  x-data="dashboardData()" inicializa Alpine.js con la funcion que 
  contiene todos los datos y métodos reactivos
-->
<body x-data="dashboardData()"> 

  <!-- Header -->
  <header class="bg-[#2D2828] shadow-md border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <!-- Interacción entre Cerar/Abrir-->
          <button @click="open = !open" class="w-10 h-10 flex items-center justify-center hover:bg-[#252121] rounded transition-colors">
            <span class="text-2xl text-white">☰</span>
          </button>
          
          <!-- Barra de busqueda 
          x-model="searchQuery" vincula el input a la variable searchQuery -->
          <div class="absolute right-60">
            <input type="text" x-model="searchQuery" placeholder="Search" class="w-full bg-gray-100 border border-gray-300 rounded-md px-2 py-2 text-sm text-gray-900 focus:outline-none focus:border-blue-500 transition shadow-sm placeholder:text-gray-400">
          </div>
          
          <!-- Dropdown de filtros -->
          <div class="fixed right-40">
            <!-- Botón para abrir/cerrar el panel de filtros -->
            <button @click="showFilters = !showFilters" class="w-10 h-10 flex items-center justify-center text-white bg-[#8E1C2D] border-2 border-[#D41736] hover:bg-[#8E1C2D] hover:border-[#772A34] transition transform duration-300 hover:scale-110 rounded">
              <i class="fa-solid fa-filter"></i>
            </button>
            
            <!-- Panel de filtros
              x-show="showFilters" muestra/oculta el panel según el valor de showFilters
              @click.outside="showFilters = false" cierra el panel al hacer clic fuera
              x-transition agrega animaciones suaves al abrir/cerrar
            -->
            <div 
              x-show="showFilters"
              @click.outside="showFilters = false"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 translate-y-1"
              x-transition:enter-end="opacity-100 translate-y-0"
              x-transition:leave="transition ease-in duration-150"
              x-transition:leave-start="opacity-100 translate-y-0"
              x-transition:leave-end="opacity-0 translate-y-1"
              class="absolute right-0 top-full w-80 bg-white rounded-lg shadow-xl border-2 border-gray-200 p-6 mt-2"
              style="display: none;">
              
              <!-- Header del panel de filtros -->
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">Filters</h3>
                <button @click="showFilters = false" class="text-gray-500 hover:text-gray-700">
                  <i class="fa-solid fa-times"></i>
                </button>
              </div>

              <div class="space-y-4">
                <!-- Por programa academico 
                x-model vincula el select a filters.program -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Program</label>
                  <select x-model="filters.program" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-[#A6192E]">
                    <option value="all">All Programs</option>
                    <option value="bachelor">Bachelor's</option>
                    <option value="associate">Associate</option>
                  </select>
                </div>

                <!-- Filtro por sesión academica -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Academic Session</label>
                  <select x-model="filters.session" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-[#A6192E]">
                    <option value="all">All Sessions</option>
                    <option value="session1">Session 1 - October</option>
                    <option value="session2">Session 2 - November</option>
                    <option value="session3">Session 3 - December</option>
                    <option value="session4">Session 4 - January</option>
                    <option value="session5">Session 5 - February</option>
                    <option value="session6">Session 6 - March</option>
                    <option value="session7">Session 7 - April</option>
                    <option value="session8">Session 8 - May</option>
                    <option value="session9">Session 9 - June</option>
                    <option value="session10">Session 10 - July</option>
                  </select>
                </div>

                <!-- Filtro por nivel de ocupación
                Criterios
                Critical: <40%, Low: 40-60%, Optimal: 60-90%, Full: >=90% -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Occupancy Level</label>
                  <select x-model="filters.occupancy" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-[#A6192E]">
                    <option value="all">All Levels</option>
                    <option value="critical">Critical</option>
                    <option value="low">Low</option>
                    <option value="optimal">Optimal</option>
                    <option value="full">Full</option>
                  </select>
                </div>

                <!-- Filtro por estado de grupo -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Group Status</label>
                  <div class="space-y-2">
                    <!-- Cada checkbox vincula su valor a una propiedad de filters -->
                    <label class="flex items-center">
                      <input type="checkbox" x-model="filters.activeGroups" class="rounded border-gray-300 text-[#A6192E] focus:ring-[#A6192E]">
                      <span class="ml-2 text-sm text-gray-700">Active Groups</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" x-model="filters.lowEnrollment" class="rounded border-gray-300 text-[#A6192E] focus:ring-[#A6192E]">
                      <span class="ml-2 text-sm text-gray-700">Low Enrollment (To Merge)</span>
                    </label>
                  </div>
                </div>

                <!-- Botones de Filtros -->
                <div class="flex gap-3 pt-4 border-t border-gray-200">
                  <button @click="clearFilters()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition text-sm font-medium">
                    Clear All
                  </button>
                  <button @click="applyFilters()" class="flex-1 px-4 py-2 bg-[#A6192E] text-white rounded-md hover:bg-[#8E1C2D] transition text-sm font-medium">
                    Apply Filters
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Foto de Perfiil o Icono -->
          <button class="w-10 h-10 flex items-center justify-center fixed right-10 hover:bg-gray-100 rounded transition-colors">
            <span class="text-2xl text-white">*</span>
          </button>
          
          <!-- Titulo -->
          <div>
            <h1 class="text-2xl font-bold text-[#2D2828]">SDGKU Dashboard</h1>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <!-- 
    x-show="open" muestra/oculta  según el valor de 'open'
    :class evalúa si se debe aplicar margen al contenido principal
    x-transition agrega animaciones de deslizamiento
  -->
  <aside 
    x-show="open"
    x-transition:enter="transition transform duration-300"
    x-transition:enter-start="-translate-x-full opacity-0"
    x-transition:enter-end="translate-x-0 opacity-100"
    x-transition:leave="transition transform duration-300"
    x-transition:leave-start="translate-x-0 opacity-100"
    x-transition:leave-end="-translate-x-full opacity-0"
    class="w-60 bg-[#A6192E] text-white h-screen p-4 top-16 fixed z-40">
    
    <!-- Menu de navegación -->
    <ul class="pt-6 space-y-4 text-xl font-medium">
      <li><a href="index.html" class="block w-full px-4 py-2 rounded hover:bg-[#971629]">Dashboard</a></li>
      <li><a href="session.html" class="block w-full px-4 py-2 rounded hover:bg-[#971629]">Sessions</a></li>
      <li><a href="subjects.html" class="block w-full px-4 py-2 rounded hover:bg-[#971629]">Subjects</a></li>
      <li><a href="#" class="block w-full px-4 py-2 rounded hover:bg-[#971629]">Students</a></li>
      <li><a href="#" class="block w-full px-4 py-2 rounded hover:bg-[#971629]">Reports</a></li>
      <li><a href="#" class="block w-full px-4 py-2 rounded hover:bg-[#971629]">Settings</a></li>
    </ul>
  </aside>

  <!-- Contenido -->
  <!-- 
    :class aplica margen izquierdo cuando el sidebar está abierto
    Esto hace que el contenido se desplace suavemente
  -->
  <main
    :class="open ? 'ml-60 transition-all duration-300' : 'ml-0 transition-all duration-300'"
    class="flex-1 p-6 bg-gray-100 min-h-screen pt-20">
    <h1 class="text-2xl font-bold mb-4">Dashboard</h1>

    <!-- Card de Metricas -->
    <!-- 
      Grid responsivo: 1 columna en móvil, 3 columnas en pantallas grandes
      x-text vincula el contenido del elemento a una variable de Alpine.js
    -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Card 1: Total de estudiantes -->
      <div class="h-28 bg-gradient-to-r from-[#A6192E] to-[#D41736] p-4 rounded-xl shadow-xl border-4 border-[#D41736] text-white flex flex-col justify-center transform transition duration-300 hover:scale-105">
        <div class="text-lg font-medium mb-2">Total Students</div>
        <!-- x-text muestra el valor de stats.totalStudents -->
        <div class="text-4xl font-bold" x-text="stats.totalStudents"></div>
      </div>
      
      <!-- Card 2: Grupos activos -->
      <div class="h-28 bg-gradient-to-r from-[#A6192E] to-[#D41736] p-4 rounded-xl shadow-xl border-4 border-[#D41736] text-white flex flex-col justify-center transform transition duration-300 hover:scale-105">
        <div class="text-lg font-medium mb-2">Active Groups</div>
        <div class="text-4xl font-bold" x-text="stats.activeGroups"></div>
      </div>
      
      <!-- Card 3: Ocupación promedio -->
      <div class="h-28 bg-gradient-to-r from-[#A6192E] to-[#D41736] p-4 rounded-xl shadow-xl border-4 border-[#D41736] text-white flex flex-col justify-center transform transition duration-300 hover:scale-105">
        <div class="text-lg font-medium mb-2">Average Occupancy</div>
        <div class="text-4xl font-bold" x-text="stats.avgOccupancy + '%'"></div>
      </div>
    </div>

    <!-- Graficas -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      
      <!-- Grafica 1: Ocupación por sesión -->
      <div class="bg-white border-2 border-[#CDCDC8] rounded shadow-lg p-4 order-1">
        <h3 class="text-lg font-bold text-[#A6192E] mb-3">Occupancy per Session</h3>
        <div style="position: relative; height: 200px;">
          <!-- Se renderiza la gráfica de Chart.js -->
          <canvas id="miGrafica"></canvas>
        </div>
      </div>

      <!-- Grafica 2: Distribución de estudiantes -->
      <div class="bg-white border-2 border-[#CDCDC8] rounded shadow-lg p-4 order-2">
        <h3 class="text-lg font-bold text-[#A6192E] mb-3">Student Distribution</h3>
        <div style="position: relative; height: 200px;">
          <canvas id="miGrafica2"></canvas>
        </div>
      </div>

      <!-- Proximas Sesiones 
      overflow-y-auto scroll vertical si hay muchas sesiones
      -->
      <div class="bg-white border-2 border-[#CDCDC8] rounded shadow-lg p-4 order-3 lg:row-span-2 overflow-y-auto overflow-x-hidden" style="max-height: 455px;">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-[#A6192E]">Upcoming sessions</h3>
          <!-- Muestra el número de sesiones filtradas -->
          <span class="text-sm text-gray-500 font-medium" x-text="upcomingSessions.length + ' sessions'"></span>
        </div>
        
        <!-- Mensaje cuando NO hay resultados después de filtrar -->
        <div x-show="upcomingSessions.length === 0" class="text-center py-8">
          <i class="fa-solid fa-filter-circle-xmark text-4xl text-gray-300 mb-3"></i>
          <p class="text-gray-500 font-medium">No sessions match the filters</p>
          <button @click="clearFilters()" class="mt-3 text-sm text-[#A6192E] hover:underline">Clear filters</button>
        </div>
        
        <!-- Lista de sesiones -->
        <div class="space-y-3">
          <!-- 
            x-for itera sobre el array upcomingSessions
            :key="session.id" es importante para que se identifique cada elemento
          -->
          <template x-for="(session, index) in upcomingSessions" :key="session.id">
            <div class="bg-[#FFFFFF] border-2 border-[#A6192E] shadow-lg rounded p-4 shadow flex items-center justify-between transition-all duration-300 hover:shadow-xl">
              <div>
                <!-- Nombre y tipo de programa -->
                <div class="flex items-center gap-3">
                  <p class="font-bold text-xl" x-text="session.name"></p>
                  <p class="text-sm text-white px-2 py-1 font-bold bg-[#B24151] rounded-md" x-text="session.program"></p>
                  <!-- x-show evalúa la condición y muestra/oculta el badge -->
                  <span x-show="session.lowEnrollment" class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded-full font-semibold">
                    Low Enrollment
                  </span>
                </div>
                
                <!-- Mes de la sesión -->
                <p class="text-lg font-medium text-gray-500" x-text="session.month"></p>
                
                <!-- Ocupación con colores distintivos por nivel -->
                <div class="flex items-center gap-4">
                  <div class="flex">
                    <p class="text-sm text-gray-500">Occupancy: </p>
                    <!-- 
                      :class aplica clases CSS dinámicamente según la ocupación:
                      - Rojo si es crítico (<40%)
                      - Ámbar si es bajo (40-60%)
                      - Verde si es óptimo (60-90%)
                      - Azul si está lleno (≥90%)
                    -->
                    <p class="text-sm font-bold ml-1"
                       :class="{
                         'text-red-600': session.occupancy < 40,
                         'text-amber-600': session.occupancy >= 40 && session.occupancy < 60,
                         'text-green-600': session.occupancy >= 60 && session.occupancy < 90,
                         'text-blue-600': session.occupancy >= 90
                       }"
                       x-text="session.occupancy + '%'"></p>
                  </div>
                </div>
              </div>
              
              <!-- Gráfica de donut individual para cada sesión -->
              <div style="width: 70px; height: 70px;">
                <!-- :id genera un ID único para cada canvas -->
                <canvas :id="'sessionChart' + session.id"></canvas>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Card Grupos criticos -->
      <div class="bg-gradient-to-r from-[#FFFFFF] to-[#F0F0F0] border-2 border-[#CDCDC8] rounded-xl shadow-lg p-6 order-4">
        <h3 class="text-lg font-bold mb-4">Critical Groups</h3>
        <div class="flex items-center justify-between">
          <div>
            <!-- Num de grupos criticos -->
            <p class="text-3xl font-bold text-[#A6192E]" x-text="stats.criticalGroups"></p>
            <p class="text-sm text-gray-600 mt-1">Groups below 40% capacity</p>
          </div>
          <button class="text-white px-6 py-2 bg-[#8E1C2D] border-2 border-[#D41736] hover:bg-[#8E1C2D] hover:border-[#772A34] transition transform duration-300 hover:scale-110 rounded">
            Details
          </button>
        </div>
      </div>

      <!-- Card Grupos para fusionar -->
      <div class="bg-gradient-to-r from-[#FFFFFF] to-[#F0F0F0] border-2 border-[#CDCDC8] rounded-xl shadow-lg p-6 order-5">
        <h3 class="text-lg font-bold mb-4">Groups to Merge</h3>
        <div class="flex items-center justify-between">
          <div>
            <!-- Num de grupos con baja inscripción -->
            <p class="text-3xl font-bold text-[#A6192E]" x-text="stats.groupsToMerge"></p>
            <p class="text-sm text-gray-600 mt-1">Low enrollment groups</p>
          </div>
          <button class="text-white px-6 py-2 bg-[#8E1C2D] border-2 border-[#D41736] hover:bg-[#8E1C2D] hover:border-[#772A34] transition transform duration-300 hover:scale-110 rounded">
            Details
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer :class="open ? 'ml-60 transition-all duration-300' : 'ml-0 transition-all duration-300'" class="bg-[#2D2828] border-t">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <p class="text-sm text-gray-300">© 2025 San Diego Global Knowledge University</p>
        <div class="flex items-center space-x-4">
          <a href="#" class="text-sm text-white hover:text-[#D41736] transition-colors">Support</a>
          <a href="#" class="text-sm text-white hover:text-[#D41736] transition-colors">Documentation</a>
          <a href="#" class="text-sm text-white hover:text-[#D41736] transition-colors">Contact</a>
        </div>
      </div>
    </div>
  </footer>

<script>
  // Variables Globales
  //Objeto para almacenar todas las instancias de Chart.js
  const chartInstances = {};

  /* Función principal de datos y métodos de Alpine.js
  Esta función retorna un objeto con todas las propiedades y métodos que serán
  accesibles en el HTML mediante x-data, x-text, x-show, etc.
   */
  function dashboardData() {
    return {
      // Controla si el sidebar está abierto o cerrado
      open: false,
      
      //Almacena el texto de búsqueda del usuario
      searchQuery: '',
      
      // Controla si el panel de filtros está visible
      showFilters: false,

      //upcomingSessions - Array de sesiones que se muestran en pantalla
      upcomingSessions: [],

      /* Filtros
       almacena todos los filtros seleccionados por el usuario
       */
      filters: {
        program: 'all',           // 'all', 'bachelor', 'associate'
        session: 'all',           // 'all', 'session1', 'session2', etc.
        occupancy: 'all',         // 'all', 'critical', 'low', 'optimal', 'full'
        activeGroups: false,      // Checkbox: grupos activos
        lowEnrollment: false,     // Checkbox: baja inscripción
        transfers: false,         // Checkbox: estudiantes con transferencias
        prerequisites: false      // Checkbox: prerequisitos pendientes
      },
      
      
      /* Metricas/Estadísticas principales
       stats - Objeto con las estadísticas principales del dashboard
       Se actualizan dinámicamente según los filtros aplicados
       */
      stats: {
        totalStudents: 1247,      // Total de estudiantes
        activeGroups: 38,         // Grupos activos
        avgOccupancy: 72,         // Ocupación promedio (porcentaje)
        criticalGroups: 5,        // Grupos con <40% de ocupación
        groupsToMerge: 8          // Grupos con baja inscripción
      },
      

      
      /* Datos para las gráficas
       sessionOccupancy - Datos para la gráfica de barras
       */
      sessionOccupancy: {
        labels: ['Session 1', 'Session 2', 'Session 3', 'Session 4', 'Session 5', 'Session 6'],
        data: [85, 72, 68, 91, 55, 78]  // Porcentajes de ocupación
      },
      
      // studentDistribution - Datos para la gráfica de pie
      studentDistribution: {
        labels: ["Bachelor's", 'Associate'],
        data: [754, 493]  // # de estudiantes por programa
      },
      
      /* Datos de sesiones (Simulación)
        allSessions - Array completo con TODAS las sesiones disponibles
      */
      allSessions: [
        { 
          id: 1,                    // ID único
          name: 'Session 1',        // Nombre de la sesión
          program: "Bachelor's",    // Programa académico
          month: 'October',         // Mes de inicio
          occupancy: 85,            // Porcentaje de ocupación
          status: 'active',         // Estado del grupo
          lowEnrollment: false      // ¿Tiene baja inscripción?
        },
        { id: 2, name: 'Session 2', program: 'Associate', month: 'November', occupancy: 72, status: 'active', lowEnrollment: false },
        { id: 3, name: 'Session 3', program: 'Associate', month: 'December', occupancy: 68, status: 'active', lowEnrollment: false },
        { id: 4, name: 'Session 4', program: "Bachelor's", month: 'January', occupancy: 91, status: 'active', lowEnrollment: false },
        { id: 5, name: 'Session 5', program: 'Associate', month: 'February', occupancy: 55, status: 'active', lowEnrollment: false },
        { id: 6, name: 'Session 6', program: "Bachelor's", month: 'March', occupancy: 78, status: 'active', lowEnrollment: false },
        { id: 7, name: 'Session 7', program: 'Associate', month: 'April', occupancy: 35, status: 'active', lowEnrollment: true },
        { id: 8, name: 'Session 8', program: "Bachelor's", month: 'May', occupancy: 42, status: 'active', lowEnrollment: true },
        { id: 9, name: 'Session 9', program: 'Associate', month: 'June', occupancy: 95, status: 'active', lowEnrollment: false },
        { id: 10, name: 'Session 10', program: "Bachelor's", month: 'July', occupancy: 28, status: 'active', lowEnrollment: true }
      ],
           
      // Métodos
      
      /* init() - Se ejecuta automáticamente cuando Alpine.js se inicializa
       Copia todas las sesiones al array de sesiones visibles a upcomingSessions
       */
      init() {
        // El operador spread [...] crea una copia del array
        this.upcomingSessions = [...this.allSessions];
      },
      
      // clearFilters() - Limpia todos los filtros y restaura el estado inicial
      clearFilters() {
        // Valor por defecto para cada filtro
        this.filters = {
          program: 'all',
          session: 'all',
          occupancy: 'all',
          activeGroups: false,
          lowEnrollment: false,
          transfers: false,
          prerequisites: false
        };
        
        // Restaurar todas las sesiones (sin filtros)
        this.upcomingSessions = [...this.allSessions];
        
        // Recalcular las estadísticas con todos los datos
        this.updateStats();
        
        // El setTimeout espera a que Alpine.js actualice el DOM (100ms)
        setTimeout(() => {
          window.createSessionCharts();
        }, 100);
      },
      
      // applyFilters() - Aplica los filtros seleccionados y actualiza la vista
      applyFilters() {
        console.log('Aplicando filtros:', this.filters);
        
        // Copia de TODAS las sesiones
        let filtered = [...this.allSessions];
        
        if (this.filters.program !== 'all') {
          // Convertir el valor del filtro al nombre completo del programa
          const programName = this.filters.program === 'bachelor' ? "Bachelor's" : 'Associate';
          
          // filter() crea un nuevo array con solo las sesiones que cumplan la condición
          filtered = filtered.filter(session => session.program === programName);
        }

        if (this.filters.session !== 'all') {
          // Extraer el # de la sesion del string "session1", etc. y se convierte a entero
          const sessionNumber = parseInt(this.filters.session.replace('session', ''));
          
          // Filtrar solo la sesión que coincida con el ID
          filtered = filtered.filter(session => session.id === sessionNumber);
        }
        
        if (this.filters.occupancy !== 'all') {
          filtered = filtered.filter(session => {
            const occ = session.occupancy; // Obtener el porcentaje de ocupación
            
            // Switch para evaluar el rango de ocupación
            switch(this.filters.occupancy) {
              case 'critical': 
                return occ < 40;              // Crítico: menos del 40%
              case 'low': 
                return occ >= 40 && occ < 60; // Bajo: entre 40% y 60%
              case 'optimal': 
                return occ >= 60 && occ < 90; // Óptimo: entre 60% y 90%
              case 'full': 
                return occ >= 90;             // Lleno: 90% o más
              default: 
                return true;                  // Si no coincide, incluir la sesión
            }
          });
        }
        
        if (this.filters.activeGroups) {
          // Solo incluir sesiones con status === 'active'
          filtered = filtered.filter(session => session.status === 'active');
        }
        
        if (this.filters.lowEnrollment) {
          // Solo incluir sesiones con lowEnrollment === true
          filtered = filtered.filter(session => session.lowEnrollment === true);
        }
        
        // NOTA: Los filtros transfers y prerequisites no tienen datos de ejemplo. 

        // Actualización del array de sesiones visibles con los resultados filtrados
        this.upcomingSessions = filtered;
        
        // Recalcular las estadisticas segun en las sesiones filtradas
        this.updateStats();
        
        // Recrear las graficas de donut para las sesiones visibles
        setTimeout(() => {
          window.createSessionCharts();
        }, 100);
        
        // Cerrar el panel de filtros
        this.showFilters = false;
        console.log('Sesiones filtradas:', filtered.length);
      },
      
      // Recalcular las estadisticas segun en las sesiones filtradas
      updateStats() {
        // Solo calcular si hay sesiones para mostrar
        if (this.upcomingSessions.length > 0) {
          
          // reduce() suma todos los valores de ocupación
          const totalOccupancy = this.upcomingSessions.reduce((sum, s) => sum + s.occupancy, 0);
          // Dividir entre el número de sesiones y redondear
          this.stats.avgOccupancy = Math.round(totalOccupancy / this.upcomingSessions.length);
          
          // filter().length cuenta las sesiones q cumplen la condición
          this.stats.activeGroups = this.upcomingSessions.filter(s => s.status === 'active').length;
          
          // Grupos con ocupación menor al 40%
          this.stats.criticalGroups = this.upcomingSessions.filter(s => s.occupancy < 40).length;

          // Grupos marcados con baja inscripción
          this.stats.groupsToMerge = this.upcomingSessions.filter(s => s.lowEnrollment).length;
        }
      }
    }
  }

  // Esperar a que el DOM esté completamente cargado
  document.addEventListener('DOMContentLoaded', function () {
    
    // Esperar 100ms para inicializar
    setTimeout(() => {
      // Obtener los datos de Alpine.js del body
      const data = Alpine.$data(document.body);
      
      // Grafica 1: Ocupación por sesión (Barras)
      const ctx1 = document.getElementById('miGrafica').getContext('2d');
      
      // Crear la gráfica y guardar la instancia en chartInstances
      chartInstances['barChart'] = new Chart(ctx1, {
        type: 'bar', 
        data: {
          // Etiquetas del eje X 
          labels: data.sessionOccupancy.labels,
          datasets: [{
            label: 'Occupancy %',
            // Datos del eje Y 
            data: data.sessionOccupancy.data,
            // Colores diferentes para cada barra
            backgroundColor: [
              '#A6192E',
              '#D41736',
              '#8E1C2D',
              '#A6192E',
              '#D41736',
              '#8E1C2D'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,              // Se adapta al tamaño del contenedor
          maintainAspectRatio: false,   // No mantiene proporción fija
          plugins: {
            legend: { display: false }   // Ocultar la leyenda
          },
          scales: {
            y: { 
              beginAtZero: true,         // El eje Y comienza en 0
              max: 100,                  // Máximo en 100%
              ticks: {
                // Función para agregar el símbolo % a cada tick
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });

      // Grafica 2 : Distribución de estudiantes (Pie)
      const ctx2 = document.getElementById('miGrafica2').getContext('2d');
      
      chartInstances['pieChart'] = new Chart(ctx2, {
        type: 'pie', 
        data: {
          // Etiquetas para cada sección del pie
          labels: data.studentDistribution.labels,
          datasets: [{
            // Datos numéricos para cada sección
            data: data.studentDistribution.data,
            // Colores para cada sección
            backgroundColor: [
              '#A6192E',  // Rojo para Bachelor's
              '#2D2828'   // Gris oscuro para Associate
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              display: true,           // Mostrar leyenda
              position: 'bottom',      // Posicionar abajo
              labels: { 
                boxWidth: 12,          // Ancho del cuadro de color
                padding: 5,            // Espaciado
                font: { size: 10 }     // Tamaño de fuente
              }
            }
          }
        }
      });

      /* Graficas de Donut para cada sesión
      createSessionCharts() - Crea gráficas de donut para cada sesión visible
      */
      window.createSessionCharts = function() {
        
        // Destruimos todo e iniciamos de nuevo
        Object.keys(chartInstances).forEach(key => {
          // Solo destruir graficas que empiecen con "sessionChart"
          if (key.startsWith('sessionChart')) {
            chartInstances[key].destroy();    // Destruir la instancia de Chart.js
            delete chartInstances[key];       // Eliminar la referencia del objeto
          }
        });

        // Creación de nuevas gráficas SOLO para las sesiones visibles
        data.upcomingSessions.forEach((session) => {
          // Buscar el canvas con el ID correspondiente
          const canvas = document.getElementById('sessionChart' + session.id);
          
          // Verificar que el canvas existe en el DOM
          if (canvas) {
            const ctx = canvas.getContext('2d');
            
            // Crear la grafica y guardar la instancia
            chartInstances['sessionChart' + session.id] = new Chart(ctx, {
              type: 'doughnut', 
              data: {
                labels: ['Occupied', 'Available'],
                datasets: [{
                  // Primer valor: porcentaje ocupado - Segundo valor: porcentaje disponible (100 - ocupado)
                  data: [session.occupancy, 100 - session.occupancy],
                  backgroundColor: [
                    '#D41736',                    // Rojo para ocupado
                    'rgba(210, 210, 210, 0.4)'   // Gris transparente para disponible
                  ],
                  borderWidth: 0 
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',  // Tamaño del hueco en el centro (70% del radio)
                plugins: {
                  legend: { display: false },  // Ocultar leyenda
                  tooltip: {
                    // Personalizar el texto del tooltip al hacer hover
                    callbacks: {
                      label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                      }
                    }
                  }
                }
              }
            });
          }
        });
      };

      // Crear las gráficas iniciales al cargar la página
      createSessionCharts();

    }, 100); // Fin del setTimeout
  });
</script>

</body>
</html>